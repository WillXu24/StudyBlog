基于**Gin**与**Mongodb**实现的成员管理系统

- 管理员和普通用户
  -  用户注册和登录

    用户信息包括用户ID、密码（数据库中加密）、昵称、手机号、邮箱地址

- 管理员
  - 删除普通用户
  - 获取一个成员、所有成员信息

- 普通用户
  
  - 更改个人信息

<!--more-->

### 零、写在前面

这算是接触golang的第一个练手项目，对于我来说，学习golang的历程差不多是这样子

- 先学**基本技能**：会用**各类工具**，学会**环境搭建**（这个我学前已经具备），别问，问就是谷歌，如果谷歌对你来说还是个404网站，那么你可能需要更多的学习（折腾）时间
- 再看**基本语法**：虽说golang与c有许多类似的地方，但是仍然有许多独特之处，基本语法的学习是非常非常枯燥的，但是也是实打实的基础知识，不能缺，所以耐着性子也得学，至少要通读官方的[go语言之旅](https://tour.go-zh.org/list)吧！
- 再学习一门**数据库**与**http协议**：这两个与golang三块在前期打基础的时候都是相对独立的知识点，可以分开学，先不用考虑他们之间的联系（当然思考这方面问题是好的），然后你可能会觉得知识如此分散，不知如何整合，不知如何下手写代码。在你觉得几方面的基础都已经有了基本的了解之后进入下一步，我再说说什么是基本的了解
  - 通读golang的基本语法，有实践教学用例
  - 了解http基本原理，明白如何发送与接受请求，知晓状态码的类别。
  - 数据库只要学会数据库的初始化以及数据的增删改读操作即可
- 学着**搭建基本的web环境**：找一些简单的web实例来编写，比如编写一个简单的完整的api，不需要很难，很简单的一个功能，比如以GET方法发出一个请求在返回页面打印一个字符串。这一步重在了解一个完整的web环境由哪些东西构成。
- 学习一门基于golang的**web框架**：例如gin、beego、echo等等框架，选择一门，看官方文档的实例，把基本的一些操作学习到，比如完整的一个基本流程、http方法的实现、请求响应信息的传输、文件的传输等等，说起来比较抽象，具体来说，就是把示例代码一个个拷到你的本机，然后一个一个运行，知道每个示例的功能以及他想要传达给你的。
- 学习**数据库对接**：想必这时候你已经比较熟悉完整的web环境了，这时候再看看你学习的数据库如何与框架对接上，一般来说都会有现成的库文件可供学习，还会在文档中给出许多示例，这时候你就需要将你在之前学习到的数据库命令在现成库中的形式学会，怎样在这个框架下初始化数据库以及对数据的一系列基本操作。
- 学习**MVC架构**：这时候你已经具有一定的代码编写能力，但是你的代码可能风格很差，但是你自己却不知道，可以搜索一些MVC架构的小项目，借鉴一下他人的代码，从而对
  MVC架构有自己的了解。
- 学习更多的库，更多的知识：这个过程是没有止境的，比前面的都重要～

好了，大概说了一些基本的历程，接下来想想总结怎么写，这个问题直到现在还在困扰着我，当我写完这个练手项目的时候我就在想着我一定要写一篇总结，但是具体的格式内容我却迟迟无法定夺，原先我想的是写成教程式的总结，什么从零开始的golang学习啊什么的，可以利用我写项目每天的日报来由浅入深的讲解自己的学习，但是我一想，本身也才学了三周的golang，会点皮毛，写出这种东西要是有错误就得狠狠地背锅，所以思来想去还是打算写成给自己看的，和给有兴趣看的人的一篇代码分析型文章吧～虽然我也不知道最后会是个什么样子。

### 一、需求分析

我们再看这个项目的需求，由于本项目没有一个规定的API文档，所以我们可以自（mang）由（mu）分析定制：

首先，用户分为管理员与普通用户，我们假定只有一位管理员，然后普通用户不限。

其次，我们看看两类用户分别需要实现的功能：

- 管理员：登录、删除成员、查看一个成员、查看所有成员，一共四个；
- 普通用户：注册、登录、修改信息，一共三个。

之后，我们看看功能背后的具体实现操作，

- 注册属于数据库增操作，

- 删除用户属于数据库删除操作，

- 登录、查看用户属于数据库查操作，

- 更新用户信息属于数据库改操作。

这时我们发现功能虽然看起来多，但是总结起来也就是那么几个基本的数据库操作所以只要学会了在特定语言环境下的数据库操作规范，就可以实现这些功能，但是还有一个问题，我们希望用户在每次访问路由的时候都能记住他的登录状态，不然登陆的作用就失去了，所以考虑用到一个jwt中间件，在用户登录的时候返回一个即时生成的TOKEN，然后下次用户发出请求的时候只需要带上 这个TOKEN服务器就能判断用户的登录状态，以此判断是否有权限进行特定的操作，例如用户的信息修改，管理员的那些高级权限操作。

那么这时候我们就可以试着按照规范将路由写出来

```go
func initRouter() {
	r := gin.New() //新建路由

	user := r.Group("/user") //用户路由组
	user.POST("/sign", )     //用户注册
	user.POST("/login", )    //用户登录
	user.Use()               //用户中间件
	{
		user.POST("/hello", )  //用户中间件测试
		user.POST("/update", ) //用户信息修改
	}

	admin := r.Group("/admin") //管理员路由组
	admin.POST("/login", )     //管理员登录（管理员账户已经内置）
	admin.Use()                //管理员中间件
	{
		admin.POST("/hello", )  //中间件测试
		admin.POST("/find", )   //查找某个用户
		admin.POST("/show", )   //查看全部用户
		admin.POST("/delete", ) //删除某个用户
	}

	_ = r.Run(":8080") //监听端口8080
}
```

然后将各个代码部分完善即可，完善过程是一个由浅入深的自我探索过程，如果你有兴趣一定会非常有收获。

### 二、代码分析

#### 1.文件结构

```
.
├── controller                 
│   ├── adminController.go
│   └── userController.go
├── database
│   └── database.go
├── go.mod
├── go.sum
├── main.go
├── middleware
│   ├── adminJwt.go
│   └── userJwt.go
├── model
│   └── user.go
├── README.md
└── router
    └── router.go
```

逐个介绍根目录下的各个目录和文件的作用

- `controller`：放置业务逻辑代码，收到路由请求后首先调用该文件夹内函数，进行一些逻辑分析判断与少数的数据处理

- `database`：放置数据库初始化连接代码，系统初始化时调用，如果数据库初始化失败直接报错并退出

- `go.mod`和`go.sum`：放置代码引用库的版本信息，与项目本身功能无关

- `main.go`：系统的入口函数，初始化一切

- `middleware`：中间件，在需要中间函数（如登录认证）的时候调用

- `model`：包含数据库操作，给controller中的函数调用

- `router`：初始化路由

#### 2.请求过程

下面具体说一下用户发送请求到我们做出响应的整个过程，以最简单的注册接口为例。

- 注意这里的请求方法是POST，对应的用户层面操作是用户填完信息点击注册的时候。

  ```go
  	user.POST("/sign", SignUpHandler)     //用户注册
  ```

- 用户点击注册按钮，将信息以特定的形式发送到服务器，服务器接受到请求

- 调用`controllers`包中的`SignUpHandler`函数，进行基本的业务逻辑处理，包括验证信息的正确性合法性等，确认无误后将数据送入数据库操作层

  ```go
  //localhost:8080/sign　　
  func SignHandler(c *gin.Context) {
  	log.Println(">>>User Signing Up<<<")
  	newuser := model.SignForm{}
  
  	//bind sign massage
  	if err := c.ShouldBind(&newuser); err != nil {
  		c.JSON(400, gin.H{"warning": "invalid massage"})
  		return
  	}
  
  	//check id availability
  	filter := bson.M{"id": newuser.Id}
  	if _, err := database.FindUser(filter); err == nil {
  		c.JSON(400, gin.H{"warning": "invalid id!"})
  		return
  	}
  
  	//encode psw to md5 before insert
  	newuser.Psw = encode(newuser.Psw)
  
  	//insert new user
  	if err := database.InsertUser(newuser); err != nil {
  		c.JSON(500, gin.H{"statu": "sorry, sign up failed!"})
  	}
  	c.JSON(200, gin.H{"statu": "sign up success!"})
  }
  ```

  

- 调用`models`层中的新增用户函数，进行数据库的底层操作，并返回结果给上层。

  ```go
  //new user sign in
  func InsertUser(user model.SignForm) error {
  	if _, err := UserColl.InsertOne(ctx, bson.M{
  		"type":  "user",
  		"id":    user.Id,
  		"psw":   user.Psw,
  		"name":  user.Name,
  		"tel":   user.Tel,
  		"email": user.Email}); err != nil {
  		return err
  	}
  	return nil
  }
  ```

- 逐层返回结果，最后返回给用户，完成一次请求与响应操作。

### 三、项目总结

  回头看，这是一个十分基础的练手项目，很适合无基础新手入门学习，收获也会比较大，会有很多小困难，但是最后的成就感也有。下面是技术总结：

- golang的基本语法
- gin框架的基本用法
- 数据库的基本操作
- 加密认证的实现-jwt
- mvc框架的基本理解
- 。。。等我想起来再补充