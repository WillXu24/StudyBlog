在服务器上搭建一些基础设施有利于提高开发与学习的效率！

比如在本地需要连接数据库、缓存或者一些搜索引擎的帮助工具等等

所以最近开始在服务器上搭建基础设施，包括

- MongoDB
- MySQL
- 。。。

## MongoDB

### 安装

安装过程详细可以参考[官方文档](https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/)更具有时效性，我就做个简单的流程总结

- 导入包管理系统使用的公钥。

  ```bash
  $ wget -qO - https://www.mongodb.org/static/pgp/server-4.0.asc | sudo apt-key add -
  ```

- 为MongoDB创建一个列表文件。

  ```bash
  ##仅适用于18.04
  $ echo "deb [ arch=amd64 ] https://repo.mongodb.org/apt/ubuntu bionic/mongodb-org/4.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.0.list
  ```

- 重新加载本地包数据库

  ```bash
  $ sudo apt-get update
  ```

- 安装最新MongoDB包。

  ```bash
  $ sudo apt-get install -y mongodb-org
  ```

### 本地配置

测试本地连接

```bash
$ sudo service mongod start
$ mongo
connecting to: mongodb://127.0.0.1:27017/?gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("7b456bed0-b904-445e-9e19-27002e2ee892") }
MongoDB server version: 4.0.12
Server has startup warnings: 
2019-08-13T16:12:19.384+0800 I STORAGE  [initandlisten] 
2019-08-13T16:12:19.384+0800 I STORAGE  [initandlisten] ** WARNING: Using the XFS filesystem is strongly recommended with the WiredTiger storage engine
2019-08-13T16:12:19.384+0800 I STORAGE  [initandlisten] **          See http://dochub.mongodb.org/core/prodnotes-filesystem
2019-08-13T16:12:20.960+0800 I CONTROL  [initandlisten] 
2019-08-13T16:12:20.960+0800 I CONTROL  [initandlisten] ** WARNING: Access control is not enabled for the database.
2019-08-13T16:12:20.960+0800 I CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.
2019-08-13T16:12:20.960+0800 I CONTROL  [initandlisten] 
---
Enable MongoDB's free cloud-based monitoring service, which will then receive and display
metrics about your deployment (disk utilization, CPU, operation statistics, etc).

The monitoring data will be available on a MongoDB website with a unique URL accessible to you
and anyone you share the URL with. MongoDB may use this information to make product
improvements and to suggest MongoDB products and deployment options to you.

To enable free monitoring, run the following command: db.enableFreeMonitoring()
To permanently disable this reminder, run the following command: db.disableFreeMonitoring()
---

> 
```

进入shell成功，本地运行正常

### 远程配置

先配置安全组，将0.0.0.0/0: 27017加入安全组

再查看并修改配置文件

```bash
$ sudo vim /etc/mongod.conf
```

```yaml
# mongod.conf

# for documentation of all options, see:
#   http://docs.mongodb.org/manual/reference/configuration-options/

# Where and how to store data.
storage:
  dbPath: /var/lib/mongodb                    
  journal:
    enabled: true
#  engine:
#  mmapv1:
#  wiredTiger:

# where to write logging data.
systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb/mongod.log

# network interfaces
net:
  port: 27017
  bindip: 127.0.0.1                            #关注点：默认监听本地ip，应改为 0.0.0.0


# how the process runs
processManagement:
  timeZoneInfo: /usr/share/zoneinfo

#security:

#operationProfiling:

#replication:

#sharding:

## Enterprise-Only Options:

#auditLog:

#snmp:

```

最后测试远程连接，有多种方式

方法一：可视化UI客户端连接，例如[robo3t](https://robomongo.org/)

方法二：安装MongoDB，通过`mongo [你的IP地址：端口]`命令连接

```bash
$ mongo 123.4.5.6:27017   ##这个是假的IP哦
MongoDB shell version v4.0.11
connecting to: mongodb://123.4.5.6:27017/test?gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("556565431687c-0d84-40f0-987e-738ec9b858f6") }
MongoDB server version: 4.0.12
Server has startup warnings: 
2019-08-13T16:12:19.384+0800 I STORAGE  [initandlisten] 
2019-08-13T16:12:19.384+0800 I STORAGE  [initandlisten] ** WARNING: Using the XFS filesystem is strongly recommended with the WiredTiger storage engine
2019-08-13T16:12:19.384+0800 I STORAGE  [initandlisten] **          See http://dochub.mongodb.org/core/prodnotes-filesystem
2019-08-13T16:12:20.960+0800 I CONTROL  [initandlisten] 
2019-08-13T16:12:20.960+0800 I CONTROL  [initandlisten] ** WARNING: Access control is not enabled for the database.
2019-08-13T16:12:20.960+0800 I CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.
2019-08-13T16:12:20.960+0800 I CONTROL  [initandlisten] 
---
Enable MongoDB's free cloud-based monitoring service, which will then receive and display
metrics about your deployment (disk utilization, CPU, operation statistics, etc).

The monitoring data will be available on a MongoDB website with a unique URL accessible to you
and anyone you share the URL with. MongoDB may use this information to make product
improvements and to suggest MongoDB products and deployment options to you.

To enable free monitoring, run the following command: db.enableFreeMonitoring()
To permanently disable this reminder, run the following command: db.disableFreeMonitoring()
---

> 
```

方法三：通过你的个人项目连接

### 其他错误

测试通过`mongod`能否打开本地服务

如果这时候直接运行数据库服务

```bash
$ mongod
2019-08-13T12:31:17.057+0800 I CONTROL  [initandlisten] MongoDB starting : pid=2101 port=27017 dbpath=/data/db 64-bit host=VM-0-17-ubuntu
2019-08-13T12:31:17.057+0800 I CONTROL  [initandlisten] db version v3.4.22
2019-08-13T12:31:17.057+0800 I CONTROL  [initandlisten] git version: aa313e18da568c4afd120f99e56d2da7d7fcdd58
2019-08-13T12:31:17.057+0800 I CONTROL  [initandlisten] OpenSSL version: OpenSSL 1.0.2g  1 Mar 2016
2019-08-13T12:31:17.057+0800 I CONTROL  [initandlisten] allocator: tcmalloc
2019-08-13T12:31:17.057+0800 I CONTROL  [initandlisten] modules: none
2019-08-13T12:31:17.057+0800 I CONTROL  [initandlisten] build environment:
2019-08-13T12:31:17.057+0800 I CONTROL  [initandlisten]     distmod: ubuntu1604
2019-08-13T12:31:17.057+0800 I CONTROL  [initandlisten]     distarch: x86_64
2019-08-13T12:31:17.058+0800 I CONTROL  [initandlisten]     target_arch: x86_64
2019-08-13T12:31:17.058+0800 I CONTROL  [initandlisten] options: {}
2019-08-13T12:31:17.058+0800 I STORAGE  [initandlisten] exception in initAndListen: 29 Data directory /data/db not found., terminating
2019-08-13T12:31:17.058+0800 I NETWORK  [initandlisten] shutdown: going to close listening sockets...
2019-08-13T12:31:17.058+0800 I NETWORK  [initandlisten] shutdown: going to flush diaglog...
2019-08-13T12:31:17.058+0800 I CONTROL  [initandlisten] now exiting
2019-08-13T12:31:17.058+0800 I CONTROL  [initandlisten] shutting down with code:100


```

提示数据库文件夹不存在，那么手动新建数据库文件并更改读写权限

```bash
$ sudo mkdir /data/db
$ sudo chown -R [你的用户名]:users /data/db
```

再次运行

```bash
$ mongod
2019-08-13T12:41:15.930+0800 I CONTROL  [initandlisten] MongoDB starting : pid=3145 port=27017 dbpath=/data/db 64-bit host=VM-0-17-ubuntu
2019-08-13T12:41:15.930+0800 I CONTROL  [initandlisten] db version v3.4.22
2019-08-13T12:41:15.930+0800 I CONTROL  [initandlisten] git version: aa313e18da568c4afd120f99e56d2da7d7fcdd58
2019-08-13T12:41:15.931+0800 I CONTROL  [initandlisten] OpenSSL version: OpenSSL 1.0.2g  1 Mar 2016
2019-08-13T12:41:15.931+0800 I CONTROL  [initandlisten] allocator: tcmalloc
2019-08-13T12:41:15.931+0800 I CONTROL  [initandlisten] modules: none
2019-08-13T12:41:15.931+0800 I CONTROL  [initandlisten] build environment:
2019-08-13T12:41:15.931+0800 I CONTROL  [initandlisten]     distmod: ubuntu1604
2019-08-13T12:41:15.931+0800 I CONTROL  [initandlisten]     distarch: x86_64
2019-08-13T12:41:15.931+0800 I CONTROL  [initandlisten]     target_arch: x86_64
2019-08-13T12:41:15.931+0800 I CONTROL  [initandlisten] options: {}
2019-08-13T12:41:15.936+0800 I STORAGE  [initandlisten] 
2019-08-13T12:41:15.936+0800 I STORAGE  [initandlisten] ** WARNING: Using the XFS filesystem is strongly recommended with the WiredTiger storage engine
2019-08-13T12:41:15.936+0800 I STORAGE  [initandlisten] **          See http://dochub.mongodb.org/core/prodnotes-filesystem
2019-08-13T12:41:15.936+0800 I STORAGE  [initandlisten] wiredtiger_open config: create,cache_size=424M,session_max=20000,eviction=(threads_min=4,threads_max=4),config_base=false,statistics=(fast),log=(enabled=true,archive=true,path=journal,compressor=snappy),file_manager=(close_idle_time=100000),checkpoint=(wait=60,log_size=2GB),statistics_log=(wait=0),verbose=(recovery_progress),
2019-08-13T12:41:16.090+0800 I CONTROL  [initandlisten] 
2019-08-13T12:41:16.091+0800 I CONTROL  [initandlisten] ** WARNING: Access control is not enabled for the database.
2019-08-13T12:41:16.091+0800 I CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.
2019-08-13T12:41:16.091+0800 I CONTROL  [initandlisten] 
2019-08-13T12:41:16.091+0800 I CONTROL  [initandlisten] 
2019-08-13T12:41:16.091+0800 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is 'always'.
2019-08-13T12:41:16.091+0800 I CONTROL  [initandlisten] **        We suggest setting it to 'never'
2019-08-13T12:41:16.091+0800 I CONTROL  [initandlisten] 
2019-08-13T12:41:16.158+0800 I FTDC     [initandlisten] Initializing full-time diagnostic data capture with directory '/data/db/diagnostic.data'
2019-08-13T12:41:16.196+0800 I INDEX    [initandlisten] build index on: admin.system.version properties: { v: 2, key: { version: 1 }, name: "incompatible_with_version_32", ns: "admin.system.version" }
2019-08-13T12:41:16.196+0800 I INDEX    [initandlisten] 	 building index using bulk method; build may temporarily use up to 500 megabytes of RAM
2019-08-13T12:41:16.197+0800 I INDEX    [initandlisten] build index done.  scanned 0 total records. 0 secs
2019-08-13T12:41:16.198+0800 I COMMAND  [initandlisten] setting featureCompatibilityVersion to 3.4
2019-08-13T12:41:16.198+0800 I NETWORK  [thread1] waiting for connections on port 27017
```

成功

### 参考文档

[Mongodb官方安装文档](https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/)

## MySQL

### 安装

若重装，则先卸载

### 本地配置

本地用户无法连接

```bash
$ mysql -uroot -p
Enter password: 
ERROR 1698 (28000): Access denied for user 'root'@'localhost'
```

先用管理员身份连接

```bash
$ sudo mysql -uroot -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 3
Server version: 5.7.27-0ubuntu0.18.04.1 (Ubuntu)

Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql>
```

再查找用户登录设置

```bash
mysql> select user, plugin from mysql.user;
+------------------+-----------------------+
| user             | plugin                |
+------------------+-----------------------+
| root             | auth_socket           |
| mysql.session    | mysql_native_password |
| mysql.sys        | mysql_native_password |
| debian-sys-maint | mysql_native_password |
+------------------+-----------------------+
4 rows in set (0.00 sec)

```

将root的认证方式改为密码

```bash
mysql> update mysql.user set authentication_string=PASSWORD('[new password]'), plugin='mysql_native_password' where user='root';
Query OK, 1 row affected, 1 warning (0.01 sec)
Rows matched: 1  Changed: 1  Warnings: 1

```

重启服务

```bash
$ sudo service mysql stop
$ sudo service mysql start
```

测试成功

```bash
$ mysql -uroot -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.27-0ubuntu0.18.04.1 (Ubuntu)

Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql>
```



### 远程配置

先配置安全组，将0.0.0.0/0: 3306加入安全组

再更改配置文件

```bash
$ sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf
##注释掉下面这一行
bind-address = 127.0.0.1
```

登录sql添加授权

```bash
$ mysql -uroot -p
##给所有用户授权
mysql> grant all privileges on *.* to 'root'@'%' identified by '573324';
Query OK, 0 rows affected, 1 warning (0.00 sec)
```

重启服务

```bash
$ sudo service mysql stop
$ sudo service mysql start
```

检验，通过mysql workbench连接

### 其他错误

## Docker



### 参考文档

[ubuntu彻底删除mysql,并重装](https://blog.csdn.net/weixin_41918841/article/details/82993537)

[MySQL ERROR 1698 (28000) 错误](https://www.cnblogs.com/leolztang/p/5094930.html)

